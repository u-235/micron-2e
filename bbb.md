## Микрон 2

Эта история началась с того, что один мой друг решил собрать
[дозиметр микрон](http://radiokot.ru/circuit/digital/measure/70/) и столкнулся
с трудностями. Самоделка никак не хотела запускаться: то не видела импульсов с
детектора, то завышала показания при повышении напряжения аккумулятора. На
форуме другу советовали искать проблему в питании детектора. Впрочем, такие
советы были в ходу с самого начала обсуждения дозиметра. Связано это с тем, что
достоверно померять напряжение на детекторе могут далеко не все радиолюбители.

### Проблема

Особенность этого дозиметра в очень экономичном потреблении энергии. Это
достигнуто за счёт адаптивного преобразователя высокого напряжения и алгоритма
работы микроконтроллера. Большую часть времени микроконтроллер спит. Из сна он
выходит по прерываниям от таймера и внешним прерываниям от датчика или кнопки.

Вот с прерываниями от датчика и связаны многие проблемы этой конструкции. Дело
в том, что Atmega8, на которой собран дозиметр, из сна может вывести внешнее
прерывание только по низкому уровню. И прерывание будет генерироваться всё время
пока на входе низкий уровень. С другой стороны, при выходе из сна МК требует,
что бы длительность низкого уровня на входе прерывания была не менее 1 мс,
иначе МК проснется но прерывания может и не произойти. Это время завязано на
опорную частоту сторожевого таймера и зависит от напряжения питания и
температуры.

Таким образом, если импульс с датчика дольше чем время обработки прерывания,
то возможны ложные срабатывания и увеличение показаний, потому что подсчет
импульсов происходит именно в этом прерывании. Если же импульс слишком короткий,
то не будет счёта.

Проблема ложных срабатываний усугубляется адаптацией количества импульсов ключа
преобразователя высокого напряжения в зависимости от напряжения. Чем выше
напряжение питания, тем меньше импульсов, а значит и их суммарное время. А из-за
того, что накачка происходит и в обработчике внешнего прерывания, то с ростом
напряжения длительность обработки сокращается. Это приводит к тому, что при
повышении напряжения и смене показаний заряда на экране прибор начинает врать.

### Способы решения проблем

Есть несколько вариантов устранения недостатков.

**Растягивать прерывание**. Пожалуй, самый простой способ бороться с ложными
срабатываниями. В обработчике прерывания от датчика отслеживать состояние входа
и выходить из прерывания только при высоком уровне.
